<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA Portal - The Cipher Circle</title>
    <style>
        :root {
            --bg: #282828;
            --bg-soft: #32302f;
            --bg-hard: #1d2021;
            --fg: #ebdbb2;
            --fg-dim: #a89984;
            --red: #fb4934;
            --green: #b8bb26;
            --yellow: #fabd2f;
            --orange: #fe8019;
            --blue: #83a598;
            --purple: #d3869b;
            --aqua: #8ec07c;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--fg);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-hard);
            padding: 0.75rem 1.5rem;
            border-bottom: 2px solid var(--orange);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .header h1 {
            font-size: 1.3rem;
            color: var(--orange);
        }

        .header-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .header select, .header button {
            background: var(--bg-soft);
            border: 1px solid var(--fg-dim);
            color: var(--fg);
            padding: 0.4rem 0.75rem;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .header select:focus, .header button:focus { outline: none; border-color: var(--orange); }

        .view-toggle {
            display: flex;
            border: 1px solid var(--fg-dim);
            border-radius: 4px;
            overflow: hidden;
        }

        .view-toggle button {
            border: none;
            border-radius: 0;
            padding: 0.4rem 0.6rem;
        }

        .view-toggle button.active {
            background: var(--orange);
            color: var(--bg);
        }

        /* LIST VIEW */
        .list-view {
            display: none;
        }

        .list-view.active {
            display: block;
        }

        .list-table {
            width: 100%;
            border-collapse: collapse;
        }

        .list-table th {
            text-align: left;
            padding: 0.5rem 0.75rem;
            background: var(--bg-hard);
            color: var(--fg-dim);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--fg-dim);
            position: sticky;
            top: 0;
        }

        .list-table td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--bg-hard);
            vertical-align: middle;
        }

        .list-table tr:hover {
            background: var(--bg-soft);
        }

        .list-table tr.approved td:first-child { border-left: 3px solid var(--green); }
        .list-table tr.needs-revision td:first-child { border-left: 3px solid var(--red); }
        .list-table tr.flagged td:first-child { border-left: 3px solid var(--yellow); }

        .list-table .name-cell {
            font-family: monospace;
            font-size: 0.85rem;
        }

        .list-table .category-cell {
            color: var(--fg-dim);
            font-size: 0.8rem;
        }

        .list-table .type-cell {
            font-size: 0.85rem;
        }

        .list-table .preview-cell {
            width: 60px;
        }

        .list-table .preview-cell img {
            width: 50px;
            height: 35px;
            object-fit: cover;
            border-radius: 3px;
            image-rendering: pixelated;
        }

        .list-table .preview-cell .audio-icon {
            width: 50px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-hard);
            border-radius: 3px;
            color: var(--blue);
        }

        .list-table .audio-cell audio {
            height: 28px;
            width: 150px;
        }

        .list-table .verdict-cell {
            width: 120px;
        }

        .list-table .verdict-buttons {
            display: flex;
            gap: 0.25rem;
        }

        .list-table .verdict-btn {
            padding: 0.25rem 0.4rem;
            border: 1px solid;
            border-radius: 2px;
            background: transparent;
            cursor: pointer;
            font-size: 0.75rem;
        }

        /* Layout */
        .layout {
            display: flex;
            min-height: calc(100vh - 110px);
        }

        .sidebar {
            width: 240px;
            background: var(--bg-soft);
            border-right: 1px solid var(--fg-dim);
            padding: 1rem;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar h3 {
            color: var(--aqua);
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sidebar-section { margin-bottom: 1.25rem; }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.5rem;
            margin-bottom: 0.2rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .filter-item:hover { background: var(--bg-hard); }
        .filter-item.active { background: var(--bg-hard); border-left: 2px solid var(--orange); }
        .filter-item .glyph { width: 18px; text-align: center; font-size: 0.9rem; }
        .filter-item .name { flex: 1; }
        .filter-item .count {
            background: var(--bg);
            padding: 0.1rem 0.35rem;
            border-radius: 6px;
            font-size: 0.7rem;
            color: var(--fg-dim);
        }

        .progress-bar {
            height: 6px;
            background: var(--bg);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.4rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--green), var(--aqua));
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 0.75rem;
            color: var(--fg-dim);
            text-align: center;
        }

        .sidebar input {
            width: 100%;
            background: var(--bg-hard);
            border: 1px solid var(--fg-dim);
            color: var(--fg);
            padding: 0.5rem;
            border-radius: 3px;
            font-size: 0.85rem;
        }

        .sidebar input:focus { outline: none; border-color: var(--orange); }

        /* Main Content */
        .main {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            padding-bottom: 80px;
        }

        /* GRID VIEW */
        .grid-view .assets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 1rem;
        }

        .grid-view .asset-card {
            background: var(--bg-soft);
            border: 2px solid var(--bg-hard);
            border-radius: 6px;
            overflow: hidden;
            transition: border-color 0.15s;
        }

        .grid-view .asset-card:hover { border-color: var(--fg-dim); }
        .grid-view .asset-card.approved { border-color: var(--green); }
        .grid-view .asset-card.needs-revision { border-color: var(--red); }
        .grid-view .asset-card.flagged { border-color: var(--yellow); }

        .grid-view .asset-preview {
            background: var(--bg-hard);
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .grid-view .asset-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            image-rendering: pixelated;
        }

        .grid-view .asset-preview.audio {
            flex-direction: column;
            gap: 0.5rem;
        }

        .grid-view .asset-preview .icon { font-size: 2rem; color: var(--blue); }
        .grid-view .asset-preview audio { width: 90%; height: 28px; }

        .grid-view .type-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            padding: 0.1rem 0.3rem;
            border-radius: 2px;
            font-size: 0.65rem;
        }

        .grid-view .asset-info { padding: 0.6rem; }
        .grid-view .asset-name {
            font-family: monospace;
            font-size: 0.8rem;
            margin-bottom: 0.2rem;
            word-break: break-all;
        }
        .grid-view .asset-meta {
            color: var(--fg-dim);
            font-size: 0.7rem;
            margin-bottom: 0.5rem;
        }

        .grid-view .verdict-buttons {
            display: flex;
            gap: 0.3rem;
        }

        .grid-view .verdict-btn {
            flex: 1;
            padding: 0.3rem;
            border: 2px solid;
            border-radius: 3px;
            background: transparent;
            color: var(--fg);
            cursor: pointer;
            font-size: 0.8rem;
        }

        .verdict-btn.approve { border-color: var(--green); }
        .verdict-btn.approve:hover, .verdict-btn.approve.selected { background: var(--green); color: var(--bg); }
        .verdict-btn.revise { border-color: var(--red); }
        .verdict-btn.revise:hover, .verdict-btn.revise.selected { background: var(--red); color: var(--bg); }
        .verdict-btn.flag { border-color: var(--yellow); }
        .verdict-btn.flag:hover, .verdict-btn.flag.selected { background: var(--yellow); color: var(--bg); }

        /* DETAIL VIEW */
        .detail-view {
            display: none;
        }

        .detail-view.active {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 110px);
        }

        .detail-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-soft);
            border-bottom: 1px solid var(--fg-dim);
        }

        .detail-nav button {
            background: var(--bg-hard);
            border: 1px solid var(--fg-dim);
            color: var(--fg);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .detail-nav button:hover { border-color: var(--orange); }
        .detail-nav button:disabled { opacity: 0.3; cursor: not-allowed; }

        .detail-nav .counter {
            color: var(--fg-dim);
            font-size: 0.9rem;
        }

        .detail-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .detail-preview {
            flex: 1;
            background: var(--bg-hard);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            overflow: hidden;
        }

        .detail-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            image-rendering: pixelated;
        }

        /* Annotation canvas overlay */
        .annotate-container {
            position: relative;
            display: inline-block;
        }

        .annotate-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
            pointer-events: auto;
        }

        .annotate-tools {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 5px;
            z-index: 10;
        }

        .annotate-tools button {
            padding: 6px 10px;
            background: var(--bg-hard);
            border: 1px solid var(--fg-dim);
            color: var(--fg);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .annotate-tools button:hover { border-color: var(--orange); }
        .annotate-tools button.active { background: var(--orange); color: var(--bg); }

        .annotation-list {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: var(--fg-dim);
        }

        .annotation-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0;
        }

        .annotation-item .remove-btn {
            background: none;
            border: none;
            color: var(--red);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .detail-preview.audio {
            flex-direction: column;
            gap: 1.5rem;
        }

        .detail-preview.audio .icon {
            font-size: 5rem;
            color: var(--blue);
        }

        .detail-preview audio {
            width: 80%;
            max-width: 500px;
        }

        .detail-panel {
            width: 400px;
            background: var(--bg-soft);
            border-left: 1px solid var(--fg-dim);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .detail-panel h2 {
            color: var(--yellow);
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            word-break: break-all;
        }

        .detail-panel .meta {
            color: var(--fg-dim);
            font-size: 0.85rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--fg-dim);
        }

        .detail-panel .meta div { margin-bottom: 0.25rem; }

        .feedback-section {
            margin-bottom: 1.5rem;
        }

        .feedback-section h3 {
            color: var(--aqua);
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .radio-option {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.6rem;
            background: var(--bg-hard);
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.15s;
        }

        .radio-option:hover { border-color: var(--fg-dim); }
        .radio-option.selected { border-color: var(--orange); }
        .radio-option.selected.approve { border-color: var(--green); }
        .radio-option.selected.redesign { border-color: var(--purple); }

        .radio-option input[type="radio"] {
            margin-top: 0.15rem;
            accent-color: var(--orange);
        }

        .radio-option .label {
            flex: 1;
        }

        .radio-option .label strong {
            display: block;
            margin-bottom: 0.2rem;
        }

        .radio-option .label small {
            color: var(--fg-dim);
            font-size: 0.8rem;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.6rem;
            background: var(--bg-hard);
            border-radius: 3px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .checkbox-option:hover { background: var(--bg); }
        .checkbox-option input { accent-color: var(--orange); }

        .feedback-section textarea {
            width: 100%;
            background: var(--bg-hard);
            border: 1px solid var(--fg-dim);
            color: var(--fg);
            padding: 0.6rem;
            border-radius: 4px;
            font-size: 0.85rem;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .feedback-section textarea:focus {
            outline: none;
            border-color: var(--orange);
        }

        .conditional-section {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed var(--fg-dim);
        }

        .conditional-section.visible {
            display: block;
        }

        .field-row {
            margin-bottom: 0.75rem;
        }

        .field-row label {
            display: block;
            font-size: 0.8rem;
            color: var(--fg-dim);
            margin-bottom: 0.25rem;
        }

        .field-row input[type="text"],
        .field-row select {
            width: 100%;
            background: var(--bg-hard);
            border: 1px solid var(--fg-dim);
            color: var(--fg);
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .field-row input:focus,
        .field-row select:focus {
            outline: none;
            border-color: var(--orange);
        }

        .checkbox-inline {
            display: flex !important;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.85rem !important;
            color: var(--fg) !important;
        }

        .checkbox-inline input {
            accent-color: var(--orange);
        }

        .radio-group.horizontal {
            flex-direction: row;
            flex-wrap: wrap;
        }

        .radio-option.small {
            padding: 0.4rem 0.6rem;
            font-size: 0.8rem;
        }

        .radio-option.small input {
            display: none;
        }

        /* Footer */
        .footer {
            position: fixed;
            bottom: 0;
            left: 240px;
            right: 0;
            background: var(--bg-hard);
            padding: 0.75rem 1.5rem;
            border-top: 2px solid var(--orange);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .stats {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .stat .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .stat .dot.approved { background: var(--green); }
        .stat .dot.revision { background: var(--red); }
        .stat .dot.flagged { background: var(--yellow); }
        .stat .dot.pending { background: var(--fg-dim); }

        .footer-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }

        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--orange); color: var(--bg); }
        .btn-secondary { background: var(--bg-soft); color: var(--fg); border: 1px solid var(--fg-dim); }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--fg-dim);
        }

        .empty-state .icon { font-size: 3rem; margin-bottom: 1rem; }

        @media (max-width: 900px) {
            .layout { flex-direction: column; }
            .sidebar { width: 100%; }
            .footer { left: 0; }
            .detail-content { flex-direction: column; }
            .detail-panel { width: 100%; }
        }

        /* Knowledge Base Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-soft);
            border: 2px solid var(--orange);
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--fg-dim);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: var(--orange);
            font-size: 1.1rem;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--fg-dim);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-close:hover { color: var(--fg); }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-body .field-row {
            margin-bottom: 1rem;
        }

        .modal-body label {
            display: block;
            font-size: 0.85rem;
            color: var(--fg-dim);
            margin-bottom: 0.3rem;
        }

        .modal-body input[type="text"],
        .modal-body input[type="url"],
        .modal-body textarea,
        .modal-body select {
            width: 100%;
            background: var(--bg-hard);
            border: 1px solid var(--fg-dim);
            color: var(--fg);
            padding: 0.6rem;
            border-radius: 4px;
            font-size: 0.9rem;
            font-family: inherit;
        }

        .modal-body textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-body input:focus,
        .modal-body textarea:focus,
        .modal-body select:focus {
            outline: none;
            border-color: var(--orange);
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--fg-dim);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .kb-type-pills {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .kb-type-pill {
            padding: 0.4rem 0.8rem;
            border: 2px solid var(--fg-dim);
            border-radius: 20px;
            background: transparent;
            color: var(--fg);
            cursor: pointer;
            font-size: 0.85rem;
        }

        .kb-type-pill:hover { border-color: var(--orange); }
        .kb-type-pill.active { border-color: var(--orange); background: var(--orange); color: var(--bg); }
    </style>
</head>
<body>
    <header class="header">
        <h1>‚öî QA Portal</h1>
        <div class="header-controls">
            <select id="projectSelect" onchange="loadProject()"></select>
            <select id="workflowSelect" onchange="applyWorkflow()">
                <option value="all">All Types</option>
                <option value="art">Art Only</option>
                <option value="audio">Audio Only</option>
                <option value="narrative">Narrative Only</option>
            </select>
            <div class="view-toggle">
                <button id="listViewBtn" onclick="setView('list')" title="List View">‚ò∞</button>
                <button id="gridViewBtn" class="active" onclick="setView('grid')" title="Grid View">‚ñ¶</button>
                <button id="detailViewBtn" onclick="setView('detail')" title="Detail Review">‚ñ£</button>
            </div>
            <button class="btn btn-secondary" onclick="openKnowledgeBase()" title="Knowledge Base Suggestion">üìö KB</button>
        </div>
    </header>

    <!-- Knowledge Base Suggestion Modal -->
    <div class="modal-overlay" id="kbModal">
        <div class="modal">
            <div class="modal-header">
                <h2>üìö Knowledge Base Suggestion</h2>
                <button class="modal-close" onclick="closeKnowledgeBase()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--fg-dim); margin-bottom: 1rem; font-size: 0.9rem;">
                    Suggest edits, corrections, or additions to <strong>knowledge.hashtopia.org</strong>
                </p>

                <div class="field-row">
                    <label>Type of Suggestion</label>
                    <div class="kb-type-pills">
                        <button class="kb-type-pill active" data-type="correction" onclick="setKbType('correction')">‚úèÔ∏è Correction</button>
                        <button class="kb-type-pill" data-type="addition" onclick="setKbType('addition')">‚ûï Addition</button>
                        <button class="kb-type-pill" data-type="typo" onclick="setKbType('typo')">üî§ Typo</button>
                        <button class="kb-type-pill" data-type="outdated" onclick="setKbType('outdated')">üìÖ Outdated</button>
                    </div>
                </div>

                <div class="field-row">
                    <label>Page URL or Topic</label>
                    <input type="text" id="kbPageUrl" placeholder="https://knowledge.hashtopia.org/... or topic name">
                </div>

                <div class="field-row">
                    <label>Section / Heading</label>
                    <input type="text" id="kbSection" placeholder="Which section of the page?">
                </div>

                <div class="field-row" id="kbCurrentTextRow">
                    <label>Current Text</label>
                    <textarea id="kbCurrentText" placeholder="Copy the text that needs changing..."></textarea>
                </div>

                <div class="field-row">
                    <label id="kbSuggestedLabel">Suggested Text</label>
                    <textarea id="kbSuggestedText" placeholder="What should it say instead?"></textarea>
                </div>

                <div class="field-row">
                    <label>Why? (optional)</label>
                    <input type="text" id="kbReason" placeholder="Brief reason for the change">
                </div>

                <div class="field-row">
                    <label>Your Name</label>
                    <input type="text" id="kbReviewer" placeholder="Your name">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeKnowledgeBase()">Cancel</button>
                <button class="btn btn-primary" onclick="submitKnowledgeBase()">Submit to Loreth</button>
            </div>
        </div>
    </div>

    <div class="layout">
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3>Progress</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progressText">0 / 0</div>
            </div>

            <div class="sidebar-section">
                <h3>Review Types</h3>
                <div id="filterList"></div>
            </div>

            <div class="sidebar-section">
                <h3>Categories</h3>
                <div id="categoryList"></div>
            </div>

            <div class="sidebar-section">
                <h3>Reviewer</h3>
                <input type="text" id="reviewerName" placeholder="Your name" onchange="saveReviewerName()">
            </div>
        </aside>

        <main class="main">
            <!-- List View -->
            <div id="listView" class="list-view">
                <table class="list-table">
                    <thead>
                        <tr>
                            <th style="width:60px">Preview</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Type</th>
                            <th>Player</th>
                            <th style="width:120px">Verdict</th>
                        </tr>
                    </thead>
                    <tbody id="listBody"></tbody>
                </table>
            </div>

            <!-- Grid View -->
            <div id="gridView" class="grid-view">
                <div class="assets-grid" id="assetsGrid"></div>
            </div>

            <!-- Detail View -->
            <div id="detailView" class="detail-view">
                <div class="detail-nav">
                    <button onclick="prevAsset()">‚Üê Previous</button>
                    <span class="counter" id="detailCounter">1 / 1</span>
                    <button onclick="nextAsset()">Next ‚Üí</button>
                </div>
                <div class="detail-content">
                    <div class="detail-preview" id="detailPreview"></div>
                    <div class="detail-panel" id="detailPanel"></div>
                </div>
            </div>
        </main>
    </div>

    <footer class="footer">
        <div class="stats">
            <div class="stat"><span class="dot approved"></span><span id="statApproved">0</span> Approved</div>
            <div class="stat"><span class="dot revision"></span><span id="statRevision">0</span> Revisions</div>
            <div class="stat"><span class="dot flagged"></span><span id="statFlagged">0</span> Flagged</div>
            <div class="stat"><span class="dot pending"></span><span id="statPending">0</span> Pending</div>
            <div class="stat save-indicator" id="saveIndicator" style="opacity: 0.5;">
                <span id="saveStatus">‚Äî</span>
            </div>
        </div>
        <div class="footer-buttons">
            <button class="btn btn-secondary" onclick="saveState()">Save</button>
            <button class="btn btn-primary" id="submitBtn" onclick="submitReview()">Submit Issues</button>
        </div>
    </footer>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SECURITY: Input Sanitization
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            if (typeof str !== 'string') str = String(str);
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function escapeMarkdown(str) {
            if (str === null || str === undefined) return '';
            if (typeof str !== 'string') str = String(str);
            return str
                .replace(/\\/g, '\\\\')
                .replace(/`/g, '\\`')
                .replace(/\|/g, '\\|')
                .replace(/\[/g, '\\[')
                .replace(/\]/g, '\\]');
        }

        function escapeAttr(str) {
            // For data attributes - escape quotes and special chars
            return escapeHtml(str);
        }

        // Config
        const REVIEW_TYPES = {
            art: { name: "Art", glyph: "‚óà", color: "#d3869b", agent: "Fraz" },
            audio: { name: "Audio", glyph: "‚ô™", color: "#83a598", agent: "Echo" },
            narrative: { name: "Narrative", glyph: "‚âã", color: "#b8bb26", agent: "Mirth" }
        };

        const ISSUE_REASONS = {
            art: ["Style mismatch", "Wrong colors", "Low quality", "Wrong size", "Doesn't fit mood", "Too busy", "Too plain", "Needs variants"],
            audio: ["Wrong mood", "Too loud", "Too quiet", "Bad loop", "Quality issues", "Wrong length", "Doesn't fit scene", "Bad fade"],
            narrative: ["Tone wrong", "Typo/grammar", "Breaks lore", "Too long", "Unclear", "Out of character", "Wrong voice"]
        };

        const PRIORITIES = [
            { value: 'blocker', label: 'üî¥ Blocker', desc: 'Stops release' },
            { value: 'high', label: 'üü† High', desc: 'Must fix before launch' },
            { value: 'normal', label: 'üü° Normal', desc: 'Should fix' },
            { value: 'low', label: 'üü¢ Low', desc: 'Nice to have' }
        ];

        const AGENTS = ['Fraz', 'Echo', 'Mirth', 'Forge', 'Vex', 'Anvil', 'Prism', 'Jinx', 'Loreth'];

        const GITHUB = { owner: "TheCipherCircle", repo: "hashtopia" };
        const STORAGE_KEY = 'qa-portal-state';

        // State
        let manifest = null;
        let currentProject = null;
        let reviewState = {};
        let activeTypes = new Set(Object.keys(REVIEW_TYPES));
        let activeCategories = new Set();
        let currentView = 'grid';
        let filteredAssets = [];
        let detailIndex = 0;
        let autoSaveTimer = null;
        let lastSaveTime = null;
        const AUTOSAVE_INTERVAL = 5000; // 5 seconds

        // Annotation state
        let annotationMode = 'circle'; // 'circle', 'rect', 'arrow'
        let isDrawing = false;
        let startX = 0, startY = 0;
        let currentCanvas = null;
        let currentCtx = null;

        async function init() {
            const savedName = localStorage.getItem('qa-reviewer-name');
            if (savedName) document.getElementById('reviewerName').value = savedName;

            const savedState = localStorage.getItem(STORAGE_KEY);
            if (savedState) {
                try {
                    const parsed = JSON.parse(savedState);
                    if (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) {
                        reviewState = parsed;
                        console.log(`Loaded ${Object.keys(reviewState).length} saved reviews`);
                    } else {
                        console.warn('Invalid review state structure, using empty state');
                        reviewState = {};
                    }
                } catch (e) {
                    console.error('Failed to parse saved state:', e);
                    reviewState = {};
                }
            }

            try {
                const response = await fetch('manifest.json');
                manifest = await response.json();
                populateProjects();
                populateFilters();
                loadProject();
            } catch (e) {
                document.getElementById('assetsGrid').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚ö†</div>
                        <p>Run: python generate-manifest.py</p>
                    </div>
                `;
            }
        }

        function populateProjects() {
            const select = document.getElementById('projectSelect');
            select.innerHTML = '';
            for (const [key, proj] of Object.entries(manifest.projects)) {
                const opt = document.createElement('option');
                opt.value = key;
                // Cleaner naming
                const name = proj.name.includes('/') ? proj.name : proj.name;
                opt.textContent = `${name} (${proj.totalAssets})`;
                select.appendChild(opt);
            }
        }

        function populateFilters() {
            const container = document.getElementById('filterList');
            container.innerHTML = '';
            for (const [key, type] of Object.entries(REVIEW_TYPES)) {
                const item = document.createElement('div');
                item.className = 'filter-item active';
                item.dataset.type = key;
                item.innerHTML = `
                    <span class="glyph" style="color: ${type.color}">${type.glyph}</span>
                    <span class="name">${type.name}</span>
                    <span class="count" id="type-count-${key}">0</span>
                `;
                item.onclick = () => toggleType(key);
                container.appendChild(item);
            }
        }

        function populateCategories() {
            const container = document.getElementById('categoryList');
            container.innerHTML = '';
            activeCategories.clear();
            if (!currentProject) return;

            for (const catKey of Object.keys(currentProject.categories)) {
                activeCategories.add(catKey);
                const cat = currentProject.categories[catKey];
                const item = document.createElement('div');
                item.className = 'filter-item active';
                item.dataset.category = catKey;
                item.innerHTML = `<span class="name">${catKey}</span><span class="count">${cat.count}</span>`;
                item.onclick = () => toggleCategory(catKey);
                container.appendChild(item);
            }
        }

        function toggleType(type) {
            if (activeTypes.has(type)) activeTypes.delete(type);
            else activeTypes.add(type);
            updateFilterUI();
            render();
        }

        function toggleCategory(cat) {
            if (activeCategories.has(cat)) activeCategories.delete(cat);
            else activeCategories.add(cat);
            updateFilterUI();
            render();
        }

        function updateFilterUI() {
            document.querySelectorAll('#filterList .filter-item').forEach(item => {
                item.classList.toggle('active', activeTypes.has(item.dataset.type));
            });
            document.querySelectorAll('#categoryList .filter-item').forEach(item => {
                item.classList.toggle('active', activeCategories.has(item.dataset.category));
            });
        }

        function loadProject() {
            const projectKey = document.getElementById('projectSelect').value;
            currentProject = manifest.projects[projectKey];
            populateCategories();
            render();
        }

        function applyWorkflow() {
            const workflow = document.getElementById('workflowSelect').value;
            activeTypes = workflow === 'all' ? new Set(Object.keys(REVIEW_TYPES)) : new Set([workflow]);
            updateFilterUI();
            render();
        }

        function setView(view) {
            currentView = view;
            document.getElementById('listViewBtn').classList.toggle('active', view === 'list');
            document.getElementById('gridViewBtn').classList.toggle('active', view === 'grid');
            document.getElementById('detailViewBtn').classList.toggle('active', view === 'detail');
            document.getElementById('listView').classList.toggle('active', view === 'list');
            document.getElementById('gridView').style.display = view === 'grid' ? 'block' : 'none';
            document.getElementById('detailView').classList.toggle('active', view === 'detail');
            if (view === 'detail') {
                detailIndex = 0;
                renderDetailView();
            }
            if (view === 'list') {
                renderListView();
            }
        }

        function getAssetKey(projectKey, catKey, assetName) {
            return `${projectKey}:${catKey}:${assetName}`;
        }

        function buildFilteredAssets() {
            filteredAssets = [];
            if (!currentProject) return;
            const projectKey = document.getElementById('projectSelect').value;

            for (const [catKey, catData] of Object.entries(currentProject.categories)) {
                if (!activeCategories.has(catKey)) continue;
                if (!activeTypes.has(catData.reviewType)) continue;

                for (const asset of catData.assets) {
                    filteredAssets.push({
                        ...asset,
                        category: catKey,
                        reviewType: catData.reviewType,
                        key: getAssetKey(projectKey, catKey, asset.name)
                    });
                }
            }
        }

        function render() {
            buildFilteredAssets();
            if (currentView === 'list') renderListView();
            else if (currentView === 'grid') renderGridView();
            else renderDetailView();
            updateStats();
        }

        function renderListView() {
            const tbody = document.getElementById('listBody');
            if (filteredAssets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--fg-dim)">No assets</td></tr>';
                return;
            }

            let html = '';
            for (const asset of filteredAssets) {
                const state = reviewState[asset.key] || {};
                const typeInfo = REVIEW_TYPES[asset.reviewType];
                const assetUrl = getAssetUrl(asset);
                const isAudio = asset.reviewType === 'audio';

                const preview = isAudio
                    ? `<div class="audio-icon">‚ô™</div>`
                    : `<img src="${assetUrl}" alt="" onerror="this.style.display='none'">`;

                const player = isAudio
                    ? `<audio controls src="${assetUrl}" preload="none"></audio>`
                    : (asset.dimensions || '‚Äî');

                html += `
                    <tr class="${state.verdict || ''}" data-key="${escapeAttr(asset.key)}">
                        <td class="preview-cell">${preview}</td>
                        <td class="name-cell">${escapeHtml(asset.name)}</td>
                        <td class="category-cell">${escapeHtml(asset.category)}</td>
                        <td class="type-cell"><span style="color:${typeInfo.color}">${typeInfo.glyph}</span> ${escapeHtml(typeInfo.name)}</td>
                        <td class="audio-cell">${player}</td>
                        <td class="verdict-cell">
                            <div class="verdict-buttons">
                                <button class="verdict-btn approve ${state.verdict === 'approved' ? 'selected' : ''}"
                                        data-key="${escapeAttr(asset.key)}" data-verdict="approved">‚úì</button>
                                <button class="verdict-btn revise ${state.verdict === 'needs-revision' ? 'selected' : ''}"
                                        data-key="${escapeAttr(asset.key)}" data-verdict="needs-revision">‚úó</button>
                                <button class="verdict-btn flag ${state.verdict === 'flagged' ? 'selected' : ''}"
                                        data-key="${escapeAttr(asset.key)}" data-verdict="flagged">‚öë</button>
                            </div>
                        </td>
                    </tr>
                `;
            }
            tbody.innerHTML = html;
        }

        function listVerdict(key, verdict) {
            if (!reviewState[key]) reviewState[key] = {};
            reviewState[key].verdict = verdict;

            const row = document.querySelector(`tr[data-key="${key}"]`);
            if (row) {
                row.className = verdict;
                row.querySelectorAll('.verdict-btn').forEach(btn => btn.classList.remove('selected'));
                const cls = verdict === 'needs-revision' ? 'revise' : verdict === 'flagged' ? 'flag' : 'approve';
                row.querySelector(`.verdict-btn.${cls}`)?.classList.add('selected');
            }

            updateStats();
            autoSave();
        }

        function getAssetUrl(asset) {
            const projectBase = currentProject.basePath.replace('/Users/petermckernan/Projects/', '');
            return `/${projectBase}/${asset.path}`;
        }

        function renderGridView() {
            const grid = document.getElementById('assetsGrid');
            if (filteredAssets.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><p>No assets</p></div>';
                return;
            }

            let html = '';
            let currentCat = null;

            for (const asset of filteredAssets) {
                const state = reviewState[asset.key] || {};
                const typeInfo = REVIEW_TYPES[asset.reviewType];
                const assetUrl = getAssetUrl(asset);
                const isAudio = asset.reviewType === 'audio';

                let preview;
                if (isAudio) {
                    preview = `<div class="asset-preview audio">
                        <span class="icon">‚ô™</span>
                        <audio controls src="${assetUrl}" preload="none"></audio>
                    </div>`;
                } else {
                    preview = `<div class="asset-preview">
                        <span class="type-badge" style="background:${typeInfo.color}">${typeInfo.glyph}</span>
                        <img src="${assetUrl}" alt="${asset.name}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22/>'">
                    </div>`;
                }

                html += `
                    <div class="asset-card ${state.verdict || ''}" data-key="${escapeAttr(asset.key)}">
                        ${preview}
                        <div class="asset-info">
                            <div class="asset-name">${escapeHtml(asset.name)}</div>
                            <div class="asset-meta">${escapeHtml(asset.category)} ¬∑ ${escapeHtml(asset.dimensions || '')}</div>
                            <div class="verdict-buttons">
                                <button class="verdict-btn approve ${state.verdict === 'approved' ? 'selected' : ''}"
                                        data-key="${escapeAttr(asset.key)}" data-verdict="approved">‚úì</button>
                                <button class="verdict-btn revise ${state.verdict === 'needs-revision' ? 'selected' : ''}"
                                        data-key="${escapeAttr(asset.key)}" data-verdict="needs-revision">‚úó</button>
                                <button class="verdict-btn flag ${state.verdict === 'flagged' ? 'selected' : ''}"
                                        data-key="${escapeAttr(asset.key)}" data-verdict="flagged">‚öë</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            grid.innerHTML = html;
        }

        function quickVerdict(key, verdict) {
            if (!reviewState[key]) reviewState[key] = {};
            reviewState[key].verdict = verdict;

            const card = document.querySelector(`.asset-card[data-key="${key}"]`);
            if (card) {
                card.className = `asset-card ${verdict}`;
                card.querySelectorAll('.verdict-btn').forEach(btn => btn.classList.remove('selected'));
                const cls = verdict === 'needs-revision' ? 'revise' : verdict === 'flagged' ? 'flag' : 'approve';
                card.querySelector(`.verdict-btn.${cls}`)?.classList.add('selected');
            }

            updateStats();
            autoSave();
        }

        function renderDetailView() {
            if (filteredAssets.length === 0) {
                document.getElementById('detailPreview').innerHTML = '<div class="empty-state"><p>No assets</p></div>';
                document.getElementById('detailPanel').innerHTML = '';
                return;
            }

            const asset = filteredAssets[detailIndex];
            const state = reviewState[asset.key] || {};
            const typeInfo = REVIEW_TYPES[asset.reviewType];
            const assetUrl = getAssetUrl(asset);
            const isAudio = asset.reviewType === 'audio';
            const reasons = ISSUE_REASONS[asset.reviewType] || [];

            // Counter
            document.getElementById('detailCounter').textContent = `${detailIndex + 1} / ${filteredAssets.length}`;

            // Preview (with escaped values) - add annotation support for art
            const preview = document.getElementById('detailPreview');
            const annotations = state.annotations || [];

            if (isAudio) {
                preview.className = 'detail-preview audio';
                preview.innerHTML = `
                    <span class="icon">‚ô™</span>
                    <div style="font-size: 1.2rem; color: var(--fg)">${escapeHtml(asset.name)}</div>
                    <audio controls src="${escapeAttr(assetUrl)}" style="width: 80%; max-width: 500px"></audio>
                `;
            } else {
                // Art preview with annotation overlay
                preview.className = 'detail-preview';
                preview.innerHTML = `
                    <div class="annotate-container" id="annotateContainer">
                        <div class="annotate-tools">
                            <button onclick="setAnnotationMode('circle')" class="${annotationMode === 'circle' ? 'active' : ''}" title="Circle">‚óã</button>
                            <button onclick="setAnnotationMode('rect')" class="${annotationMode === 'rect' ? 'active' : ''}" title="Rectangle">‚ñ°</button>
                            <button onclick="setAnnotationMode('arrow')" class="${annotationMode === 'arrow' ? 'active' : ''}" title="Arrow">‚Üí</button>
                            <button onclick="clearAnnotations('${escapeAttr(asset.key)}')" title="Clear all">‚úï</button>
                        </div>
                        <img id="annotateImg" src="${escapeAttr(assetUrl)}" alt="${escapeAttr(asset.name)}" onload="initAnnotationCanvas()">
                        <canvas id="annotateCanvas" class="annotate-canvas"></canvas>
                    </div>
                `;
            }

            // Panel - get all state
            const decision = state.decision || (state.verdict === 'approved' ? 'approve' : state.verdict ? 'redesign' : '');
            const issueReasons = state.issueReasons || [];
            const direction = state.direction || '';
            const priority = state.priority || 'normal';
            const whereUsed = state.whereUsed || '';
            const testedInGame = state.testedInGame || false;
            const alternativeRef = state.alternativeRef || '';
            const assignee = state.assignee || '';
            const dependencies = state.dependencies || '';
            const needsMultipleApproval = state.needsMultipleApproval || false;
            const approvers = state.approvers || [];

            // Type-specific
            const volumeLevel = state.volumeLevel || '';
            const loopQuality = state.loopQuality || '';
            const fadeNotes = state.fadeNotes || '';
            const paletteOk = state.paletteOk !== false;
            const variantsNeeded = state.variantsNeeded || '';
            const characterVoice = state.characterVoice || '';
            const loreRefs = state.loreRefs || '';

            // Build type-specific fields (using data attributes for security)
            const safeKeyForType = escapeAttr(asset.key);
            let typeSpecificHtml = '';
            if (asset.reviewType === 'audio') {
                typeSpecificHtml = `
                    <div class="feedback-section">
                        <h3>Audio Details</h3>
                        <div class="field-row">
                            <label>Volume Level:</label>
                            <select data-key="${safeKeyForType}" data-field="volumeLevel">
                                <option value="">‚Äî Select ‚Äî</option>
                                <option value="too-loud" ${volumeLevel === 'too-loud' ? 'selected' : ''}>Too Loud</option>
                                <option value="ok" ${volumeLevel === 'ok' ? 'selected' : ''}>OK</option>
                                <option value="too-quiet" ${volumeLevel === 'too-quiet' ? 'selected' : ''}>Too Quiet</option>
                            </select>
                        </div>
                        <div class="field-row">
                            <label>Loop Quality:</label>
                            <select data-key="${safeKeyForType}" data-field="loopQuality">
                                <option value="">‚Äî Select ‚Äî</option>
                                <option value="seamless" ${loopQuality === 'seamless' ? 'selected' : ''}>Seamless</option>
                                <option value="acceptable" ${loopQuality === 'acceptable' ? 'selected' : ''}>Acceptable</option>
                                <option value="noticeable" ${loopQuality === 'noticeable' ? 'selected' : ''}>Noticeable Gap</option>
                                <option value="na" ${loopQuality === 'na' ? 'selected' : ''}>N/A (doesn't loop)</option>
                            </select>
                        </div>
                        <div class="field-row">
                            <label>Fade Notes:</label>
                            <input type="text" placeholder="Fade in/out requirements..."
                                   value="${escapeAttr(fadeNotes)}" data-key="${safeKeyForType}" data-field="fadeNotes">
                        </div>
                    </div>
                `;
            } else if (asset.reviewType === 'art') {
                typeSpecificHtml = `
                    <div class="feedback-section">
                        <h3>Art Details</h3>
                        <div class="field-row">
                            <label class="checkbox-inline">
                                <input type="checkbox" ${paletteOk ? 'checked' : ''}
                                       data-key="${safeKeyForType}" data-field="paletteOk">
                                Palette compliant (Gruvbox)
                            </label>
                        </div>
                        <div class="field-row">
                            <label>Variants Needed:</label>
                            <input type="text" placeholder="e.g., hover, disabled, selected..."
                                   value="${escapeAttr(variantsNeeded)}" data-key="${safeKeyForType}" data-field="variantsNeeded">
                        </div>
                    </div>
                `;
            } else if (asset.reviewType === 'narrative') {
                typeSpecificHtml = `
                    <div class="feedback-section">
                        <h3>Narrative Details</h3>
                        <div class="field-row">
                            <label>Character Voice:</label>
                            <input type="text" placeholder="Which character speaks this?"
                                   value="${escapeAttr(characterVoice)}" data-key="${safeKeyForType}" data-field="characterVoice">
                        </div>
                        <div class="field-row">
                            <label>Lore References:</label>
                            <input type="text" placeholder="Related lore entries to check..."
                                   value="${escapeAttr(loreRefs)}" data-key="${safeKeyForType}" data-field="loreRefs">
                        </div>
                    </div>
                `;
            }

            // Build panel with escaped values and data attributes
            const safeKey = escapeAttr(asset.key);

            document.getElementById('detailPanel').innerHTML = `
                <h2>${escapeHtml(asset.name)}</h2>
                <div class="meta">
                    <div><strong>Category:</strong> ${escapeHtml(asset.category)}</div>
                    <div><strong>Type:</strong> ${typeInfo.glyph} ${escapeHtml(typeInfo.name)}</div>
                    <div><strong>Path:</strong> ${escapeHtml(asset.path)}</div>
                    ${asset.dimensions ? `<div><strong>Size:</strong> ${escapeHtml(asset.dimensions)}</div>` : ''}
                    <div><strong>Build:</strong> ${escapeHtml(manifest.generated.split('T')[0])}</div>
                    <div><strong>Hash:</strong> ${escapeHtml(asset.hash || '‚Äî')}</div>
                    ${!isAudio ? `<div style="margin-top:0.5rem;" id="annotationInfo">
                        <span style="color:var(--orange)">üìç ${annotations.length} annotation${annotations.length !== 1 ? 's' : ''}</span>
                        ${annotations.length > 0 ? `<button class="btn btn-secondary" style="font-size:0.75rem;padding:0.3rem 0.6rem;margin-left:0.5rem;" onclick="exportAnnotatedImage()">üì• Export</button>` : '<small style="color:var(--fg-dim);margin-left:0.5rem;">(draw on image to mark issues)</small>'}
                    </div>` : ''}
                </div>

                <div class="feedback-section">
                    <h3>Decision</h3>
                    <div class="radio-group">
                        <label class="radio-option approve ${decision === 'approve' ? 'selected' : ''}"
                               data-key="${safeKey}" data-decision="approve">
                            <input type="radio" name="decision" value="approve" ${decision === 'approve' ? 'checked' : ''}>
                            <div class="label">
                                <strong>‚úì Approve</strong>
                                <small>Ready to ship as-is</small>
                            </div>
                        </label>
                        <label class="radio-option ${decision === 'minor' ? 'selected' : ''}"
                               data-key="${safeKey}" data-decision="minor">
                            <input type="radio" name="decision" value="minor" ${decision === 'minor' ? 'checked' : ''}>
                            <div class="label">
                                <strong>‚ö° Minor Tweak</strong>
                                <small>Small adjustments needed</small>
                            </div>
                        </label>
                        <label class="radio-option redesign ${decision === 'redesign' ? 'selected' : ''}"
                               data-key="${safeKey}" data-decision="redesign">
                            <input type="radio" name="decision" value="redesign" ${decision === 'redesign' ? 'checked' : ''}>
                            <div class="label">
                                <strong>‚úé Needs Redesign</strong>
                                <small>Significant changes required</small>
                            </div>
                        </label>
                        <label class="radio-option ${decision === 'replace' ? 'selected' : ''}"
                               data-key="${safeKey}" data-decision="replace">
                            <input type="radio" name="decision" value="replace" ${decision === 'replace' ? 'checked' : ''}>
                            <div class="label">
                                <strong>‚Üî Replace</strong>
                                <small>Use different asset entirely</small>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="feedback-section">
                    <h3>Context</h3>
                    <div class="field-row">
                        <label>Where Used:</label>
                        <input type="text" placeholder="Encounter ID, screen name, scene..."
                               value="${escapeAttr(whereUsed)}" data-key="${safeKey}" data-field="whereUsed">
                    </div>
                    <div class="field-row">
                        <label class="checkbox-inline">
                            <input type="checkbox" ${testedInGame ? 'checked' : ''}
                                   data-key="${safeKey}" data-field="testedInGame">
                            Tested in-game (not just isolated review)
                        </label>
                    </div>
                </div>

                <div class="conditional-section ${decision && decision !== 'approve' ? 'visible' : ''}" id="issueSection">
                    <div class="feedback-section">
                        <h3>Priority</h3>
                        <div class="radio-group horizontal">
                            ${PRIORITIES.map(p => `
                                <label class="radio-option small ${priority === p.value ? 'selected' : ''}"
                                       data-key="${safeKey}" data-priority="${escapeAttr(p.value)}">
                                    <input type="radio" name="priority" value="${escapeAttr(p.value)}" ${priority === p.value ? 'checked' : ''}>
                                    <span>${escapeHtml(p.label)}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <div class="feedback-section">
                        <h3>What's the issue?</h3>
                        <div class="checkbox-group">
                            ${reasons.map(r => `
                                <label class="checkbox-option">
                                    <input type="checkbox" ${issueReasons.includes(r) ? 'checked' : ''}
                                           data-key="${safeKey}" data-reason="${escapeAttr(r)}">
                                    ${escapeHtml(r)}
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    ${typeSpecificHtml}

                    <div class="feedback-section">
                        <h3>Creative Direction</h3>
                        <textarea placeholder="What should it look/sound like instead? Any references or examples?"
                                  data-key="${safeKey}" data-field="direction">${escapeHtml(direction)}</textarea>
                    </div>

                    <div class="feedback-section">
                        <h3>Alternative/Reference</h3>
                        <input type="text" placeholder="Link to alternative asset or reference image/audio..."
                               value="${escapeAttr(alternativeRef)}" data-key="${safeKey}" data-field="alternativeRef">
                    </div>

                    <div class="feedback-section">
                        <h3>Assignment</h3>
                        <div class="field-row">
                            <label>Assign to:</label>
                            <select data-key="${safeKey}" data-field="assignee">
                                <option value="">‚Äî Auto (${escapeHtml(typeInfo.agent)} queue) ‚Äî</option>
                                ${AGENTS.map(a => `<option value="${escapeAttr(a)}" ${assignee === a ? 'selected' : ''}>${escapeHtml(a)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="field-row">
                            <label>Dependencies:</label>
                            <input type="text" placeholder="Other assets that must be fixed first..."
                                   value="${escapeAttr(dependencies)}" data-key="${safeKey}" data-field="dependencies">
                        </div>
                    </div>

                    <div class="feedback-section">
                        <h3>Approval</h3>
                        <div class="field-row">
                            <label class="checkbox-inline">
                                <input type="checkbox" ${needsMultipleApproval ? 'checked' : ''}
                                       data-key="${safeKey}" data-field="needsMultipleApproval">
                                Needs multiple approvers (critical asset)
                            </label>
                        </div>
                    </div>
                </div>
            `;
        }

        function setDecision(key, decision) {
            if (!reviewState[key]) reviewState[key] = {};
            reviewState[key].decision = decision;
            reviewState[key].verdict = decision === 'approve' ? 'approved' :
                                       decision === 'minor' ? 'flagged' : 'needs-revision';
            renderDetailView();
            updateStats();
            autoSave();
        }

        function toggleReason(key, reason) {
            if (!reviewState[key]) reviewState[key] = {};
            if (!reviewState[key].issueReasons) reviewState[key].issueReasons = [];

            const idx = reviewState[key].issueReasons.indexOf(reason);
            if (idx >= 0) reviewState[key].issueReasons.splice(idx, 1);
            else reviewState[key].issueReasons.push(reason);

            autoSave();
        }

        function setDirection(key, direction) {
            if (!reviewState[key]) reviewState[key] = {};
            reviewState[key].direction = direction;
            autoSave();
        }

        function setField(key, field, value) {
            if (!reviewState[key]) reviewState[key] = {};
            reviewState[key][field] = value;
            autoSave();
        }

        function prevAsset() {
            if (detailIndex > 0) {
                detailIndex--;
                renderDetailView();
            }
        }

        function nextAsset() {
            if (detailIndex < filteredAssets.length - 1) {
                detailIndex++;
                renderDetailView();
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ANNOTATION SYSTEM - Draw on images to highlight issues
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function initAnnotationCanvas() {
            const img = document.getElementById('annotateImg');
            const canvas = document.getElementById('annotateCanvas');
            if (!img || !canvas) return;

            // Size canvas to match image
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            canvas.style.width = img.width + 'px';
            canvas.style.height = img.height + 'px';

            currentCanvas = canvas;
            currentCtx = canvas.getContext('2d');
            currentCtx.strokeStyle = '#fb4934'; // Gruvbox red
            currentCtx.lineWidth = 3;
            currentCtx.lineCap = 'round';

            // Load existing annotations
            const asset = filteredAssets[detailIndex];
            if (asset) {
                const state = reviewState[asset.key] || {};
                if (state.annotations && state.annotations.length > 0) {
                    redrawAnnotations(state.annotations);
                }
            }

            // Event listeners
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', endDrawing);
            canvas.addEventListener('mouseleave', endDrawing);
        }

        function setAnnotationMode(mode) {
            annotationMode = mode;
            document.querySelectorAll('.annotate-tools button').forEach((btn, i) => {
                const modes = ['circle', 'rect', 'arrow'];
                btn.classList.toggle('active', modes[i] === mode);
            });
        }

        function getCanvasCoords(e) {
            const canvas = currentCanvas;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            const coords = getCanvasCoords(e);
            startX = coords.x;
            startY = coords.y;
        }

        function draw(e) {
            if (!isDrawing || !currentCtx) return;
            const coords = getCanvasCoords(e);

            // Redraw existing annotations first
            const asset = filteredAssets[detailIndex];
            const state = reviewState[asset.key] || {};
            currentCtx.clearRect(0, 0, currentCanvas.width, currentCanvas.height);
            redrawAnnotations(state.annotations || []);

            // Draw current shape in preview
            currentCtx.strokeStyle = '#fb4934';
            currentCtx.lineWidth = 3;

            if (annotationMode === 'circle') {
                const radius = Math.sqrt(Math.pow(coords.x - startX, 2) + Math.pow(coords.y - startY, 2));
                currentCtx.beginPath();
                currentCtx.arc(startX, startY, radius, 0, 2 * Math.PI);
                currentCtx.stroke();
            } else if (annotationMode === 'rect') {
                currentCtx.strokeRect(startX, startY, coords.x - startX, coords.y - startY);
            } else if (annotationMode === 'arrow') {
                drawArrow(currentCtx, startX, startY, coords.x, coords.y);
            }
        }

        function endDrawing(e) {
            if (!isDrawing) return;
            isDrawing = false;

            const coords = getCanvasCoords(e);
            const asset = filteredAssets[detailIndex];
            if (!asset) return;

            // Save the annotation
            if (!reviewState[asset.key]) reviewState[asset.key] = {};
            if (!reviewState[asset.key].annotations) reviewState[asset.key].annotations = [];

            const annotation = {
                type: annotationMode,
                startX, startY,
                endX: coords.x,
                endY: coords.y,
                id: Date.now()
            };

            // Only save if significant size (avoid accidental clicks)
            const dist = Math.sqrt(Math.pow(coords.x - startX, 2) + Math.pow(coords.y - startY, 2));
            if (dist > 10) {
                reviewState[asset.key].annotations.push(annotation);
                autoSave();
            }

            // Final redraw
            const state = reviewState[asset.key];
            currentCtx.clearRect(0, 0, currentCanvas.width, currentCanvas.height);
            redrawAnnotations(state.annotations || []);
        }

        function redrawAnnotations(annotations) {
            if (!currentCtx || !annotations) return;

            currentCtx.strokeStyle = '#fb4934';
            currentCtx.lineWidth = 3;

            annotations.forEach((a, i) => {
                if (a.type === 'circle') {
                    const radius = Math.sqrt(Math.pow(a.endX - a.startX, 2) + Math.pow(a.endY - a.startY, 2));
                    currentCtx.beginPath();
                    currentCtx.arc(a.startX, a.startY, radius, 0, 2 * Math.PI);
                    currentCtx.stroke();
                    // Number label
                    currentCtx.fillStyle = '#fb4934';
                    currentCtx.font = 'bold 16px sans-serif';
                    currentCtx.fillText((i + 1).toString(), a.startX - 5, a.startY + 5);
                } else if (a.type === 'rect') {
                    currentCtx.strokeRect(a.startX, a.startY, a.endX - a.startX, a.endY - a.startY);
                    currentCtx.fillStyle = '#fb4934';
                    currentCtx.font = 'bold 16px sans-serif';
                    currentCtx.fillText((i + 1).toString(), a.startX + 5, a.startY + 18);
                } else if (a.type === 'arrow') {
                    drawArrow(currentCtx, a.startX, a.startY, a.endX, a.endY);
                    currentCtx.fillStyle = '#fb4934';
                    currentCtx.font = 'bold 16px sans-serif';
                    currentCtx.fillText((i + 1).toString(), a.startX - 10, a.startY - 5);
                }
            });
        }

        function drawArrow(ctx, fromX, fromY, toX, toY) {
            const headLen = 15;
            const angle = Math.atan2(toY - fromY, toX - fromX);

            ctx.beginPath();
            ctx.moveTo(fromX, fromY);
            ctx.lineTo(toX, toY);
            ctx.lineTo(toX - headLen * Math.cos(angle - Math.PI / 6), toY - headLen * Math.sin(angle - Math.PI / 6));
            ctx.moveTo(toX, toY);
            ctx.lineTo(toX - headLen * Math.cos(angle + Math.PI / 6), toY - headLen * Math.sin(angle + Math.PI / 6));
            ctx.stroke();
        }

        function clearAnnotations(key) {
            if (confirm('Clear all annotations on this image?')) {
                if (reviewState[key]) {
                    reviewState[key].annotations = [];
                    autoSave();
                }
                if (currentCtx && currentCanvas) {
                    currentCtx.clearRect(0, 0, currentCanvas.width, currentCanvas.height);
                }
            }
        }

        function getAnnotationDataUrl() {
            // Get combined image + annotations as data URL
            if (!currentCanvas) return null;
            const img = document.getElementById('annotateImg');
            if (!img) return null;

            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = currentCanvas.width;
            tempCanvas.height = currentCanvas.height;
            const tempCtx = tempCanvas.getContext('2d');

            // Draw original image
            tempCtx.drawImage(img, 0, 0);
            // Draw annotations on top
            tempCtx.drawImage(currentCanvas, 0, 0);

            return tempCanvas.toDataURL('image/png');
        }

        function exportAnnotatedImage() {
            const dataUrl = getAnnotationDataUrl();
            if (!dataUrl) {
                alert('No image to export');
                return;
            }

            const asset = filteredAssets[detailIndex];
            const filename = `annotated_${asset.name.replace(/\.[^.]+$/, '')}_${Date.now()}.png`;

            // Create download link
            const link = document.createElement('a');
            link.download = filename;
            link.href = dataUrl;
            link.click();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // KNOWLEDGE BASE SUGGESTION MODAL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let kbType = 'correction';

        function openKnowledgeBase() {
            document.getElementById('kbModal').classList.add('active');
            // Pre-fill reviewer name if saved
            const savedName = document.getElementById('reviewerName').value;
            if (savedName) {
                document.getElementById('kbReviewer').value = savedName;
            }
        }

        function closeKnowledgeBase() {
            document.getElementById('kbModal').classList.remove('active');
        }

        function setKbType(type) {
            kbType = type;
            document.querySelectorAll('.kb-type-pill').forEach(pill => {
                pill.classList.toggle('active', pill.dataset.type === type);
            });

            // Adjust UI based on type
            const currentTextRow = document.getElementById('kbCurrentTextRow');
            const suggestedLabel = document.getElementById('kbSuggestedLabel');

            if (type === 'addition') {
                currentTextRow.style.display = 'none';
                suggestedLabel.textContent = 'Content to Add';
            } else {
                currentTextRow.style.display = 'block';
                suggestedLabel.textContent = type === 'typo' ? 'Corrected Text' : 'Suggested Text';
            }
        }

        function submitKnowledgeBase() {
            const pageUrl = document.getElementById('kbPageUrl').value.trim();
            const section = document.getElementById('kbSection').value.trim();
            const currentText = document.getElementById('kbCurrentText').value.trim();
            const suggestedText = document.getElementById('kbSuggestedText').value.trim();
            const reason = document.getElementById('kbReason').value.trim();
            const reviewer = document.getElementById('kbReviewer').value.trim() || 'Anonymous';

            if (!pageUrl && !section) {
                alert('Please specify a page URL or topic');
                return;
            }
            if (!suggestedText) {
                alert('Please provide your suggested text or addition');
                return;
            }

            // Build title
            const typeLabels = {
                correction: 'Correction',
                addition: 'Addition',
                typo: 'Typo',
                outdated: 'Outdated'
            };
            const title = `[KB] ${typeLabels[kbType]}: ${section || pageUrl}`;

            // Build body
            let body = `## üìö Knowledge Base Suggestion\n\n`;
            body += `| Field | Value |\n|-------|-------|\n`;
            body += `| **Type** | ${escapeMarkdown(typeLabels[kbType])} |\n`;
            body += `| **Page** | ${escapeMarkdown(pageUrl || 'N/A')} |\n`;
            body += `| **Section** | ${escapeMarkdown(section || 'N/A')} |\n`;
            body += `| **Reviewer** | ${escapeMarkdown(reviewer)} |\n\n`;

            if (currentText && kbType !== 'addition') {
                body += `### Current Text\n\`\`\`\n${escapeMarkdown(currentText)}\n\`\`\`\n\n`;
            }

            const actionLabel = kbType === 'addition' ? 'Proposed Addition' : 'Suggested Change';
            body += `### ${actionLabel}\n\`\`\`\n${escapeMarkdown(suggestedText)}\n\`\`\`\n\n`;

            if (reason) {
                body += `### Reason\n${escapeMarkdown(reason)}\n\n`;
            }

            body += `---\n*Submitted via QA Portal ¬∑ ${new Date().toISOString()}*`;

            // Create GitHub issue URL
            const labels = ['documentation', 'loreth-queue', 'knowledge-base'];
            const url = `https://github.com/${GITHUB.owner}/${GITHUB.repo}/issues/new?` +
                new URLSearchParams({ title, body, labels: labels.join(',') });

            window.open(url, '_blank');
            closeKnowledgeBase();

            // Clear form
            document.getElementById('kbPageUrl').value = '';
            document.getElementById('kbSection').value = '';
            document.getElementById('kbCurrentText').value = '';
            document.getElementById('kbSuggestedText').value = '';
            document.getElementById('kbReason').value = '';
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeKnowledgeBase();
            }
        });

        // Close modal on overlay click
        document.getElementById('kbModal')?.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeKnowledgeBase();
            }
        });

        function updateStats() {
            const projectKey = document.getElementById('projectSelect').value;
            let approved = 0, revision = 0, flagged = 0, pending = 0, total = 0;

            if (currentProject) {
                for (const [catKey, catData] of Object.entries(currentProject.categories)) {
                    for (const asset of catData.assets) {
                        total++;
                        const key = getAssetKey(projectKey, catKey, asset.name);
                        const state = reviewState[key];
                        if (!state || !state.verdict) pending++;
                        else if (state.verdict === 'approved') approved++;
                        else if (state.verdict === 'needs-revision') revision++;
                        else if (state.verdict === 'flagged') flagged++;
                    }
                }
            }

            document.getElementById('statApproved').textContent = approved;
            document.getElementById('statRevision').textContent = revision;
            document.getElementById('statFlagged').textContent = flagged;
            document.getElementById('statPending').textContent = pending;

            const reviewed = approved + revision + flagged;
            const pct = total > 0 ? Math.round((reviewed / total) * 100) : 0;
            document.getElementById('progressFill').style.width = `${pct}%`;
            document.getElementById('progressText').textContent = `${reviewed}/${total} (${pct}%)`;

            document.getElementById('submitBtn').disabled = (revision + flagged) === 0;

            // Update type counts
            const typeCounts = { art: 0, audio: 0, narrative: 0 };
            filteredAssets.forEach(a => typeCounts[a.reviewType]++);
            for (const [type, count] of Object.entries(typeCounts)) {
                const el = document.getElementById(`type-count-${type}`);
                if (el) el.textContent = count;
            }
        }

        function saveReviewerName() {
            localStorage.setItem('qa-reviewer-name', document.getElementById('reviewerName').value);
        }

        function autoSave() {
            // Debounce autosave to avoid excessive writes
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(reviewState));
                    lastSaveTime = new Date();
                    updateSaveIndicator('saved');
                } catch (e) {
                    console.error('Autosave failed:', e);
                    updateSaveIndicator('error');
                }
            }, 500);
        }

        function updateSaveIndicator(status) {
            const indicator = document.getElementById('saveIndicator');
            const statusEl = document.getElementById('saveStatus');
            if (!indicator || !statusEl) return;

            if (status === 'saved') {
                statusEl.textContent = '‚úì Saved';
                indicator.style.color = 'var(--green)';
                indicator.style.opacity = '1';
                // Fade out after 2 seconds
                setTimeout(() => { indicator.style.opacity = '0.5'; }, 2000);
            } else if (status === 'saving') {
                statusEl.textContent = '‚ãØ Saving...';
                indicator.style.color = 'var(--yellow)';
                indicator.style.opacity = '1';
            } else if (status === 'error') {
                statusEl.textContent = '‚úó Save failed';
                indicator.style.color = 'var(--red)';
                indicator.style.opacity = '1';
            }
        }

        function saveState() {
            updateSaveIndicator('saving');
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(reviewState));
                lastSaveTime = new Date();
                updateSaveIndicator('saved');
            } catch (e) {
                console.error('Save failed:', e);
                updateSaveIndicator('error');
                alert('Save failed! Check browser storage limits.');
            }
        }

        function submitReview() {
            const reviewer = document.getElementById('reviewerName').value.trim() || 'Anonymous';
            const projectKey = document.getElementById('projectSelect').value;
            const projectName = currentProject.name;

            const issuesByType = {};

            for (const [catKey, catData] of Object.entries(currentProject.categories)) {
                for (const asset of catData.assets) {
                    const key = getAssetKey(projectKey, catKey, asset.name);
                    const state = reviewState[key];
                    if (state && state.verdict && state.verdict !== 'approved') {
                        const type = catData.reviewType;
                        if (!issuesByType[type]) issuesByType[type] = [];
                        issuesByType[type].push({
                            asset: asset.name,
                            category: catKey,
                            decision: state.decision || 'needs-revision',
                            reasons: state.issueReasons || [],
                            direction: state.direction || '',
                            path: asset.path,
                            // New fields
                            priority: state.priority || 'normal',
                            whereUsed: state.whereUsed || '',
                            testedInGame: state.testedInGame || false,
                            alternativeRef: state.alternativeRef || '',
                            assignee: state.assignee || '',
                            dependencies: state.dependencies || '',
                            needsMultipleApproval: state.needsMultipleApproval || false,
                            // Type-specific
                            volumeLevel: state.volumeLevel || '',
                            loopQuality: state.loopQuality || '',
                            fadeNotes: state.fadeNotes || '',
                            paletteOk: state.paletteOk,
                            variantsNeeded: state.variantsNeeded || '',
                            characterVoice: state.characterVoice || '',
                            loreRefs: state.loreRefs || '',
                            // Annotations
                            annotations: state.annotations || []
                        });
                    }
                }
            }

            const issueUrls = [];

            for (const [type, issues] of Object.entries(issuesByType)) {
                const typeInfo = REVIEW_TYPES[type];

                // Check if any are blockers
                const hasBlocker = issues.some(i => i.priority === 'blocker');
                const priorityLabel = hasBlocker ? 'priority-blocker' : '';

                const title = `[${typeInfo.name.toUpperCase()}] ${projectName} - ${issues.length} item(s)${hasBlocker ? ' üî¥ BLOCKER' : ''}`;

                // Build issue body with escaped markdown content
                let body = `## ${typeInfo.glyph} ${escapeMarkdown(typeInfo.name)} Review\n\n`;
                body += `| Field | Value |\n|-------|-------|\n`;
                body += `| **Reviewer** | ${escapeMarkdown(reviewer)} |\n`;
                body += `| **Project** | ${escapeMarkdown(projectName)} |\n`;
                body += `| **Build** | ${escapeMarkdown(manifest.generated.split('T')[0])} |\n`;
                body += `| **Queue** | ${escapeMarkdown(typeInfo.agent)} |\n\n`;
                body += `---\n\n`;

                issues.forEach((issue, i) => {
                    const priorityIcon = issue.priority === 'blocker' ? 'üî¥' : issue.priority === 'high' ? 'üü†' : issue.priority === 'low' ? 'üü¢' : 'üü°';
                    const decisionIcon = issue.decision === 'redesign' ? '‚úé' : issue.decision === 'replace' ? '‚Üî' : '‚ö°';

                    body += `### ${priorityIcon} ${i + 1}. \`${escapeMarkdown(issue.asset)}\`\n\n`;
                    body += `| | |\n|---|---|\n`;
                    body += `| **Decision** | ${decisionIcon} ${escapeMarkdown(issue.decision.toUpperCase())} |\n`;
                    body += `| **Priority** | ${escapeMarkdown(issue.priority?.toUpperCase() || 'NORMAL')} |\n`;
                    if (issue.whereUsed) body += `| **Where Used** | ${escapeMarkdown(issue.whereUsed)} |\n`;
                    if (issue.testedInGame) body += `| **Tested In-Game** | ‚úì Yes |\n`;
                    if (issue.assignee) body += `| **Assigned To** | ${escapeMarkdown(issue.assignee)} |\n`;
                    body += `| **Path** | \`${escapeMarkdown(issue.path)}\` |\n\n`;

                    if (issue.reasons.length) body += `**Issues:** ${escapeMarkdown(issue.reasons.join(', '))}\n\n`;

                    // Type-specific fields
                    if (type === 'audio') {
                        if (issue.volumeLevel) body += `**Volume:** ${escapeMarkdown(issue.volumeLevel)}\n`;
                        if (issue.loopQuality) body += `**Loop:** ${escapeMarkdown(issue.loopQuality)}\n`;
                        if (issue.fadeNotes) body += `**Fade:** ${escapeMarkdown(issue.fadeNotes)}\n`;
                    } else if (type === 'art') {
                        if (issue.paletteOk === false) body += `**Palette:** ‚ö†Ô∏è Not compliant\n`;
                        if (issue.variantsNeeded) body += `**Variants Needed:** ${escapeMarkdown(issue.variantsNeeded)}\n`;
                    } else if (type === 'narrative') {
                        if (issue.characterVoice) body += `**Character:** ${escapeMarkdown(issue.characterVoice)}\n`;
                        if (issue.loreRefs) body += `**Lore Refs:** ${escapeMarkdown(issue.loreRefs)}\n`;
                    }

                    // Include annotations if present (art assets)
                    if (issue.annotations && issue.annotations.length > 0) {
                        body += `\n**üìç Marked Areas (${issue.annotations.length}):**\n`;
                        issue.annotations.forEach((a, idx) => {
                            const typeLabel = a.type === 'circle' ? '‚óã Circle' : a.type === 'rect' ? '‚ñ° Box' : '‚Üí Arrow';
                            body += `- **#${idx + 1}** ${typeLabel} at (${Math.round(a.startX)}, ${Math.round(a.startY)})\n`;
                        });
                        body += `\n*Open asset in QA Portal to view annotated screenshot*\n`;
                    }

                    if (issue.direction) body += `\n**Creative Direction:**\n> ${escapeMarkdown(issue.direction).replace(/\n/g, '\n> ')}\n`;
                    if (issue.alternativeRef) body += `\n**Alternative/Reference:** ${escapeMarkdown(issue.alternativeRef)}\n`;
                    if (issue.dependencies) body += `\n**Dependencies:** ${escapeMarkdown(issue.dependencies)}\n`;
                    if (issue.needsMultipleApproval) body += `\n‚ö†Ô∏è **Needs multiple approvers**\n`;

                    body += `\n---\n\n`;
                });

                body += `*Submitted via QA Portal ¬∑ ${new Date().toISOString()}*`;

                const labels = [`${type}-review`, `${typeInfo.agent.toLowerCase()}-queue`];
                if (hasBlocker) labels.push('priority-blocker');

                const url = `https://github.com/${GITHUB.owner}/${GITHUB.repo}/issues/new?` +
                    new URLSearchParams({ title, body, labels: labels.join(',') });

                issueUrls.push({ type: typeInfo.name, url });
            }

            if (issueUrls.length === 1) window.open(issueUrls[0].url, '_blank');
            else if (issueUrls.length > 1 && confirm(`Creating ${issueUrls.length} issues. Continue?`)) {
                issueUrls.forEach(i => window.open(i.url, '_blank'));
            }
        }

        // Keyboard navigation for detail view
        document.addEventListener('keydown', (e) => {
            if (currentView !== 'detail') return;
            if (e.key === 'ArrowLeft') prevAsset();
            if (e.key === 'ArrowRight') nextAsset();
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EVENT DELEGATION - Secure handlers without inline string interpolation
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        document.addEventListener('click', (e) => {
            // Handle verdict buttons (list and grid views)
            const verdictBtn = e.target.closest('.verdict-btn[data-key][data-verdict]');
            if (verdictBtn) {
                const key = verdictBtn.dataset.key;
                const verdict = verdictBtn.dataset.verdict;
                if (key && verdict) {
                    // Determine which view we're in
                    if (currentView === 'list') {
                        listVerdict(key, verdict);
                    } else if (currentView === 'grid') {
                        quickVerdict(key, verdict);
                    }
                }
                return;
            }

            // Handle decision radio options (detail view)
            const decisionOption = e.target.closest('.radio-option[data-key][data-decision]');
            if (decisionOption) {
                const key = decisionOption.dataset.key;
                const decision = decisionOption.dataset.decision;
                if (key && decision) {
                    setDecision(key, decision);
                }
                return;
            }

            // Handle priority options (detail view)
            const priorityOption = e.target.closest('.radio-option[data-key][data-priority]');
            if (priorityOption) {
                const key = priorityOption.dataset.key;
                const priority = priorityOption.dataset.priority;
                if (key && priority) {
                    setField(key, 'priority', priority);
                    renderDetailView();
                }
                return;
            }
        });

        // Handle checkbox changes (issue reasons)
        document.addEventListener('change', (e) => {
            const checkbox = e.target.closest('input[type="checkbox"][data-key][data-reason]');
            if (checkbox) {
                const key = checkbox.dataset.key;
                const reason = checkbox.dataset.reason;
                if (key && reason) {
                    toggleReason(key, reason);
                }
                return;
            }

            // Handle field inputs
            const fieldInput = e.target.closest('[data-key][data-field]');
            if (fieldInput) {
                const key = fieldInput.dataset.key;
                const field = fieldInput.dataset.field;
                const value = fieldInput.type === 'checkbox' ? fieldInput.checked : fieldInput.value;
                if (key && field !== undefined) {
                    setField(key, field, value);
                }
                return;
            }
        });

        // Periodic background save check (every 30 seconds, save if there are unsaved changes)
        setInterval(() => {
            const currentState = JSON.stringify(reviewState);
            const savedState = localStorage.getItem(STORAGE_KEY);
            if (currentState !== savedState) {
                autoSave();
            }
        }, 30000);

        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            const currentState = JSON.stringify(reviewState);
            const savedState = localStorage.getItem(STORAGE_KEY);
            if (currentState !== savedState) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            }
        });

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
